apiVersion: v1
kind: Pod
metadata:
  name: migrate-<%= deployment_id %>
spec:
  containers:
    - name: migrate
      args:
        - bundle
        - exec
        - rake
        - db:migrate
      env: <%= partial 'rails_environment' %>
      image: airhorns/ifm:<%= current_sha %>
      ports:
      - containerPort: 3000
      resources: {}
      stdin: true
      tty: true
    - name: cloudsql-proxy
      image: gcr.io/cloudsql-docker/gce-proxy:1.11
      command: ["/cloud_sql_proxy",
                "-instances=integrated-farm-manager:us-central1:development-tiny-backend=tcp:5432",
                "-credential_file=/secrets/cloudsql/credentials.json"]
      volumeMounts:
        - name: cloudsql-instance-credentials
          mountPath: /secrets/cloudsql
          readOnly: true
  restartPolicy: Always
  volumes:
    - name: cloudsql-instance-credentials
      secret:
        secretName: cloudsql-instance-credentials
